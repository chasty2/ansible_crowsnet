---
# Setup NFS mounts and postgres container
- name: Service Config block
  become: true
  tags: services
  block:
    - name: Create /mnt/postgres
      ansible.builtin.file:
        path: /mnt/postgres
        state: directory
        owner: ansible
        group: postgres
        mode: "0770"

    - name: Mount postgres NFS volume
      ansible.posix.mount:
        src: 192.168.4.11:/ssd_mirror/postgres
        path: /mnt/postgres
        opts: rw,sync,hard
        state: mounted
        fstype: nfs

    ## TODO: Configure rootless mode
    - name: Create postgres container
      containers.podman.podman_container:
        name: postgres
        image: docker.io/postgres:15.8
        network: host
        env:
          POSTGRES_PASSWORD: "{{ postgres_password }}"
          PGDATA: "/var/lib/postgresql/data/pgdata"
        mount:
          - "type=bind,source=/mnt/postgres,destination=/var/lib/postgresql/data/pgdata,rw=true"
        state: created
        rm: true

    - name: Generate systemd unit file for postgres container
      containers.podman.podman_generate_systemd:
        name: postgres
        new: true
        no_header: true
        dest: /etc/systemd/system

    - name: Ensure postgres container is started and enabled
      ansible.builtin.systemd:
        name: container-postgres
        daemon_reload: true
        state: started
        enabled: true
